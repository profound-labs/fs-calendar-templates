\ProvidesPackage{calendar-local}

\input{../translation-keys.tex}

\LoadTranslations

\luadirect{
require("../template-helpers/helpers.lua")
setDateTexts(tonumber(\CalendarYear), \luastring{\@wall@eventsCsv})
}

% === Fonts ===

\usepackage{fontspec}
\defaultfontfeatures{Ligatures={TeX}}
\setmainfont[
  ItalicFont = Shaker Pali Italic,
  BoldFont = Shaker 2 Bold,
]{Shaker Pali Regular}

\newfontfamily\ShakerLightFont[
  ItalicFont = Shaker 2 Light Italic,
]{Shaker 2 Light}

\newfontfamily\ShakerRegularFont[
  ItalicFont = Shaker Pali Italic,
  BoldFont = Shaker 2 Bold,
]{Shaker Pali Regular}

% === Packages ===

\usepackage{textcomp}

\usepackage{soul}

\usepackage{hyperref}
\hypersetup{
  colorlinks=true,
  unicode=true,
  linkcolor=textbody,
  citecolor=textbody,
  filecolor=textbody,
  urlcolor=textbody
}

% === Cover settings ===

\newlength\coverHeight
\setlength\coverHeight{\calPaperHeight + 6mm}
\newlength\coverWidth
\setlength\coverWidth{\calPaperWidth + 6mm}

% Slight background color on the cover page
\ifvarnishmask
  \definecolor{coverbgcolor}{gray}{0}
\else
  \definecolor{coverbgcolor}{gray}{0.9}
\fi

% Pantone 730C
% HEX #9e652e
% CMYK 10, 55, 83, 35

% Sepia Brown in Gimp plugin
% close to named color Sandal
% HEX #A28A65
% CMYK 0, 38, 96, 93

\definecolor{browntan}{cmyk}{0, 0.15, 0.38, 0.36}

\newcommand\WallCoverPage{%
  \IfFileExists{./wall-cover-\@wall@calendarLanguage.tex}%
  {\input{./wall-cover-\@wall@calendarLanguage.tex}}%
  {\input{./wall-cover.tex}}
}%

\newcommand\DeskCoverPage{%
  \IfFileExists{./desk-cover-\@wall@calendarLanguage.tex}%
  {\input{./desk-cover-\@wall@calendarLanguage.tex}}%
  {\input{./desk-cover.tex}}
}%

% === Year Planner Page ===

\newcommand\plannerYearFmt{\fontsize{26}{26}\selectfont\color{orangegold}}

\newlength\plannerNotesSep
\newlength\plannerTitleSep
\newlength\plannerTopSkip
\setlength{\plannerNotesSep}{3mm}
\setlength{\plannerTitleSep}{7mm}
\setlength{\plannerTopSkip}{0pt}

\newcommand\preYearPlannerPageHook{}

\newcommand\printPlannerTitle{\plannerYearFmt \CalendarYear\ / \CalendarAltYear}

\newcommand\tabcolgap{\hspace*{20pt}}

% Using the /parseYearEvents values, but calling a different helper function
% #1 = option keys
\newcommand*\parseYearEventsAsThreeColsTable[1][]{%
\pgfkeys{/parseYearEvents, defaults, #1,
  year/.get=\@t@year,
  filter pred/.get=\@t@filterPred,
  events csv/.get=\@t@eventsCsv,
}%
\luadirect{
require("../template-helpers/helpers.lua")
yearEventsAsThreeColsTable(
  tonumber(\@t@year),
  \@t@filterPred,
  \luastring{\@t@eventsCsv}
)}}

\renewcommand\plannerEvents{%
\hspace*{-\@wall@leftMargin}%
\begin{minipage}{\calPaperWidth}%
\centering
\fontsize{9}{12}\selectfont%
\parseYearEventsAsThreeColsTable[filter pred = hasNote]%
\par%
\end{minipage}}

\newcommand\YearPlannerPortraitPage{%
\newpage
\ifvarnishmask
\mbox{}
\else
\preYearPlannerPageHook

\vspace*{\plannerTopSkip}%

{\centering

{\printPlannerTitle}

\vspace*{\plannerTitleSep}

\YearPlannerPortrait

\vspace*{\plannerNotesSep}

\plannerEvents

}

\fi
}

% === Thumbs Page ===

\newlength\@wall@tmp@a
\newlength\@wall@tmp@b

\newlength\@wall@thumbWidth
\newlength\@wall@thumbHeight
\newlength\@wall@thumbCaptionWidth
\setlength{\@wall@thumbWidth}{0.1749\calPaperWidth}% 30mm at the 6.75in page width, 0.1749 = 1/5.715
\setlength{\@wall@thumbHeight}{\@wall@thumbWidth}
\setlength{\@wall@thumbCaptionWidth}{0.2333\calPaperWidth}% 40mm at 6.75in page width

\newcommand\thumbFmt{}
\newcommand\thumbMonthFmt{\fontsize{10}{13}\selectfont\bfseries}
\newcommand\thumbCaptionFmt{\fontsize{10}{13}\selectfont}

\def\@wall@thumbFile{}
\def\@wall@photoCaption{}

\newcommand\ThumbWithCaptionLeftSide[1]{%
\pgfkeys{/Photo/#1/thumbFile/.get=\@wall@thumbFile}%
\ifx\@wall@thumbFile\empty
  \pgfkeys{/Photo/#1/file/.get=\@wall@thumbFile}%
\fi
\pgfkeys{/Photo/#1/caption/.get=\@wall@photoCaption}%
% Thumbnail caption
\ifvarnishmask%
\hspace*{\@wall@thumbWidth}
\else%
\begin{minipage}[b][\@wall@thumbHeight][t]{\@wall@thumbCaptionWidth}%
\raggedleft
\thumbFmt
{\thumbMonthFmt \@tr@monthNumName{\monthToNum{#1}}}\par
{\thumbCaptionFmt \@wall@photoCaption}%
\end{minipage}%
\fi%
\hspace*{3mm}
% Thumbnail photo
\begin{minipage}[b][\@wall@thumbHeight]{\@wall@thumbWidth}%
\placeholder{hasvarnish}{%
\includegraphics[ keepaspectratio, height=\@wall@thumbHeight ]{\@wall@thumbFile}%
}%
\end{minipage}%
}

\newcommand\ThumbWithCaptionRightSide[1]{%
\pgfkeys{/Photo/#1/thumbFile/.get=\@wall@thumbFile}%
\ifx\@wall@thumbFile\empty
  \pgfkeys{/Photo/#1/file/.get=\@wall@thumbFile}%
\fi
\pgfkeys{/Photo/#1/caption/.get=\@wall@photoCaption}%
% Thumbnail photo
\begin{minipage}[b][\@wall@thumbHeight]{\@wall@thumbWidth}%
\placeholder{hasvarnish}{%
\includegraphics[ keepaspectratio, height=\@wall@thumbHeight ]{\@wall@thumbFile}%
}%
\end{minipage}%
\hspace*{3mm}
% Thumbnail caption
\ifvarnishmask%
\hspace*{\@wall@thumbWidth}
\else%
\begin{minipage}[b][\@wall@thumbHeight][t]{\@wall@thumbCaptionWidth}%
\raggedright
\thumbFmt
{\thumbMonthFmt \@tr@monthNumName{\monthToNum{#1}}}\par
{\thumbCaptionFmt \@wall@photoCaption}%
\end{minipage}%
\fi%
}

\newlength{\thumbColumnWidth}
\newlength{\thumbColumnHeight}
\newlength{\thumbSep}
\newlength{\@t@a}
\newlength{\@t@b}

% vertical spacing
\setlength{\@t@a}{0.2\textheight}

% horizontal spacing
\setlength{\@t@b}{0.2\@wall@thumbCaptionWidth}% 8mm at 40mm caption width

\ifdimcomp{\@t@a}{<}{\@t@b}{
  \setlength{\thumbSep}{\@t@a}
}{
  \setlength{\thumbSep}{\@t@b}
}

\setlength{\thumbColumnWidth}{0.5\calPaperWidth - \thumbSep}
\setlength{\thumbColumnHeight}{\textheight}

\newcommand\ThumbsPage{%
\clearpage

\hspace*{-\@wall@leftMargin}%
\hspace*{-1pt}% small correction, space gets in somewhere
% Wrap
\begin{minipage}[t][\thumbColumnHeight]{\calPaperWidth}%
\centering%
\setlength{\parindent}{0pt}%
\setlength{\parskip}{0pt}%

% NOTE: multicols will not \vfill
% Left Column
\begin{minipage}[t][\thumbColumnHeight]{\thumbColumnWidth}%
\raggedleft

\ThumbWithCaptionLeftSide{January}

\vspace*{\thumbSep}

\ThumbWithCaptionLeftSide{March}

\vspace*{\thumbSep}

\ThumbWithCaptionLeftSide{May}

\vspace*{\thumbSep}

\ThumbWithCaptionLeftSide{July}

\vspace*{\thumbSep}

\ThumbWithCaptionLeftSide{September}

\vspace*{\thumbSep}

\ThumbWithCaptionLeftSide{November}

% End of left column
\end{minipage}%
%
\hspace*{\thumbSep}%
%
% Right column
\begin{minipage}[t][\thumbColumnHeight]{\thumbColumnWidth}%
\raggedright

\ThumbWithCaptionRightSide{February}

\vspace*{\thumbSep}

\ThumbWithCaptionRightSide{April}

\vspace*{\thumbSep}

\ThumbWithCaptionRightSide{June}

\vspace*{\thumbSep}

\ThumbWithCaptionRightSide{August}

\vspace*{\thumbSep}

\ThumbWithCaptionRightSide{October}

\vspace*{\thumbSep}

\ThumbWithCaptionRightSide{December}

% End of right column
\end{minipage}%

% End of wrap
\end{minipage}%
}

% === Macros ===

\newcommand*\quoteRef[1]{\itshape #1}

\sodef\soChapter{}{.1em}{.5em plus.1em}{.1em plus.1em minus.1em}

\newcommand\spacedcdot{\hspace{0.3em}$\cdot$\hspace{0.3em}}

\renewcommand{\thumbMonthFmt}{\color{gold}\bfseries}

\renewcommand\symbolSeparator{\thinspace}

\newcommand{\FrontmatterFmt}{%
\fontsize{9}{14}\selectfont%
\setlength{\parskip}{0.7\baselineskip}%
}

\newcommand*{\s}[1]{\textsuperscript{#1}}

\newcommand\tabgap{\hspace*{5pt}}

\newcommand\NotesTwoCols[2]{%
\begin{multicols}{2}%
\raggedright

\begin{tabular}{@{} l @{} l @{\tabgap} l @{}}
#1
\end{tabular}

\columnbreak
\raggedleft

\begin{tabular}{@{} r @{\tabgap} c @{\tabgap} l @{\tabgap} c @{\tabgap} r @{}}
#2
\end{tabular}

\end{multicols}%
}

\newcommand\parseMonthMarksDayTextAsCornerMarks{%
\luadirect{
require("../template-helpers/helpers.lua")
tex.sprint(';')
monthMarksDayTextAsCornerMarks(\luastring{\theMonthName}, nil, \luastring{\@wall@eventsCsv})
}}

\newcommand{\calendarMarks}{%
  \parseMonthMarksDayText%
  \parseMonthMarksNote%
}

\newcommand{\calendarText}{%
  \NotesTwoCols{%
    \parseMonthEvents[filter pred = hasNote, format func = eventFmtNotes, min events = 3]%
  }{%
    \parseMonthEvents[filter pred = isUposatha, format func = eventFmtUposathas, min events = 3]%
  }%
}

\newcommand{\xCenterOffset}{0.5\linewidth - 0.5\paperwidth -3mm}

\colorlet{quoteboxbg}{browntan!25!black}

\newlength\quoteBoxHeight
\setlength{\quoteBoxHeight}{34mm}

\newcommand{\quoteBox}[1]{%
\begin{tikzpicture}%
\node [fill=quoteboxbg, opacity=0.8, minimum width={\paperwidth + 3mm}, minimum height=\quoteBoxHeight] {};%
\node [] {%
\begin{minipage}{\paperwidth + 3mm}%
\centering
\begin{minipage}{\calPaperWidth - \@wall@leftMargin - \@wall@rightMargin}%
\centering
\color{white}
#1
\end{minipage}%
\end{minipage}%
};
\end{tikzpicture}%
}

